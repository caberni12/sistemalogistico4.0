<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Log√≠stico Integrado</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
 --bg:#f1f5f9;
 --card:#ffffff;
 --hover:#f8fafc;
 --text:#0f172a;
 --muted:#64748b;
 --accent:#14b8a6;
 --border:#e2e8f0;
 --danger:#ef4444;
}

*{ box-sizing:border-box; font-family:system-ui,Arial,sans-serif; }

body{
 margin:0;
 background:var(--bg);
 color:var(--text);
 min-height:100vh;
 display:flex;
 flex-direction:column;
}

/* HEADER */
header{
 display:flex;
 align-items:center;
 justify-content:space-between;
 padding:18px 22px;
 background:#ffffff;
 border-bottom:1px solid var(--border);
 box-shadow:0 4px 12px rgba(0,0,0,.04);
}

header h1{
 margin:0;
 font-size:20px;
 font-weight:700;
}

header .right{
 display:flex;
 gap:10px;
 align-items:center;
}

header .user{
 font-size:13px;
 color:var(--muted);
}

header button{
 background:var(--danger);
 color:#fff;
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 font-weight:600;
}

/* GRID */
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
 gap:20px;
 padding:28px;
 max-width:1200px;
 margin:auto;
 width:100%;
}

/* CARD */
.card{
 background:var(--card);
 border-radius:18px;
 padding:26px;
 text-align:center;
 cursor:pointer;
 transition:.25s ease;
 border:1px solid var(--border);
 box-shadow:0 6px 18px rgba(0,0,0,.06);
}

.card:hover{
 background:var(--hover);
 transform:translateY(-4px);
 box-shadow:0 10px 28px rgba(0,0,0,.08);
}

.card-icon{ font-size:38px; margin-bottom:12px; }
.card h3{ margin:8px 0 4px; font-size:16px; font-weight:600; }
.card p{ font-size:13px; color:var(--muted); }

/* VIEWER */
.viewer{
 display:none;
 flex-direction:column;
 height:100vh;
 background:#ffffff;
}

.viewer-header{
 background:#ffffff;
 border-bottom:1px solid var(--border);
 padding:12px 16px;
 display:flex;
 align-items:center;
 justify-content:space-between;
 box-shadow:0 4px 12px rgba(0,0,0,.04);
}

.viewer-header span{ font-weight:600; }

.viewer-header button{
 background:var(--accent);
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 color:#fff;
 font-weight:600;
}

.viewer iframe{
 flex:1;
 border:none;
 width:100%;
}
</style>
</head>

<body>

<header>
  <h1>üöÄ Sistema de Gestion Logistica AS</h1>
  <div class="right">
    <div id="usuario" class="user"></div>
    <button onclick="cerrarSesion()">‚èª Cerrar Sesi√≥n</button>
  </div>
</header>

<!-- PANEL DIN√ÅMICO -->
<div id="panel" class="grid"></div>

<!-- VISOR -->
<div id="viewer" class="viewer">
  <div class="viewer-header">
    <span id="viewerTitle"></span>
    <button onclick="volver()">‚¨Ö Volver</button>
  </div>
  <iframe id="frame"></iframe>
</div>

<script>
/* ========= CONFIG ========= */
const API = "https://script.google.com/macros/s/AKfycbyq636FeKfcAodPz8oqBTYVy1ic2dRP_-W0Hy2dCdptVSOSsaGyEQBMAeTwV0JFqYY3/exec";

/* ========= SESI√ìN ========= */
async function validarSesion(){
  const token = localStorage.getItem("token");
  const ip = localStorage.getItem("ip");

  if(!token){ location.href="index.html"; return; }

  try{
    const r = await fetch(API+"?action=verify&token="+token+"&ip="+ip);
    const data = await r.json();

    if(!data.valid){
      localStorage.clear();
      location.href="index.html";
      return;
    }

    document.getElementById("usuario").innerHTML =
      `üë§ ${data.nombre} ¬∑ ${data.rol}`;

    cargarModulos(data);

  }catch{
    location.href="index.html";
  }
}

/* ========= MODULOS ========= */
async function cargarModulos(user){

  const permisos = (user.permisos || "").split(",");
  const r = await fetch(API+"?action=listarModulos");
  const data = await r.json();

  const panel = document.getElementById("panel");
  panel.innerHTML = "";

  data.data.forEach(m=>{
    const [id,nombre,archivo,icono,permiso,activo] = m;
    if(activo !== "SI") return;

    // ADMIN ve todo
    if(user.rol !== "ADMIN" && !permisos.includes(permiso)) return;

    panel.innerHTML += `
      <div class="card" onclick="abrir('${archivo}','${nombre}')">
        <div class="card-icon">${icono || "üì¶"}</div>
        <h3>${nombre}</h3>
        <p>M√≥dulo del sistema</p>
      </div>
    `;
  });
}

/* ========= VISOR ========= */
function abrir(url,titulo){
  document.getElementById("panel").style.display="none";
  document.getElementById("viewer").style.display="flex";
  document.getElementById("frame").src=url;
  document.getElementById("viewerTitle").textContent=titulo;
}

function volver(){
  document.getElementById("viewer").style.display="none";
  document.getElementById("panel").style.display="grid";
  document.getElementById("frame").src="";
}

/* ========= LOGOUT ========= */
function cerrarSesion(){
  localStorage.clear();
  location.href="index.html";
}

/* ========= INIT ========= */
validarSesion();
</script>

<script src="app_pro.js"></script>
<script src="segurity.js"></script>
</body>
</html>
